name: 运行nextjs和cpolar

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:   
    - name: 下载当前项目
      uses: actions/checkout@v4 

    - name: 运行 nextjs       
      run: |                 
          cd ./nextjs/         
          npm install
          npm run dev & 
          
    - name: 运行 cpolar       
      run: |      
        cd ./cpolar/ 
        chmod a+rwx ./cpolar
        ./cpolar authtoken ZmQ0MjM4YTYtNThkYS00ODQxLWJiMDUtYmI1ZDY4ODRmMTM4
        echo "已授权"
        ./cpolar http 3000 &
      
    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      
    - name: 终止进程       
      run: |      
        pkill cpolar
        # pkill node
        
    - name: 部署 sqlite3
      uses: JamesIves/github-pages-deploy-action@v4
      with: 
          branch: main
          folder: sqlite3/
          target-folder: sqlite3/
          
    - name: 删除运行记录
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        retain_days: 0
        keep_minimum_runs: 1
