name: 运行nextjs和cpolar

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:   
    - name: 下载当前项目
      uses: actions/checkout@v4 

    - name: 运行 nextjs       
      run: |     
          npm i -g pnpm
          cd ./nextjs/         
          pnpm i
          pnpm run dev & 
      env:
          NEXTJS_CONFIG_DEFAULT_DB: ${{ secrets.NEXTJS_CONFIG_DEFAULT_DB }}  
          NEXTJS_CONFIG_PG01: ${{ secrets.NEXTJS_CONFIG_PG01 }}  
          NEXTJS_CONFIG_PG02: ${{ secrets.NEXTJS_CONFIG_PG02 }}  
          NEXTJS_CONFIG_SQLITE: ${{ secrets.NEXTJS_CONFIG_SQLITE }} 

    - name: 运行 cpolar       
      run: |      
        cd ./cpolar/ 
        chmod a+rwx ./cpolar
        ./cpolar authtoken ${{ secrets.CPOLAR_AUTHTOKEN }}  
        echo "已授权"
        ./cpolar http 3000 &
      
    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      
    - name: 复制到发布目录       
      run: |                
         mkdir ./releases/
         if [ -f "./sqlite3/shopee/采集箱/粉丝/br.db" ]; then
           cp ./sqlite3/shopee/采集箱/粉丝/br.db ./releases/shopee_gather_fans_br.db 
         fi
         if [ -f "./sqlite3/shopee/采集箱/粉丝/my.db" ]; then
           cp ./sqlite3/shopee/采集箱/粉丝/my.db ./releases/shopee_gather_fans_my.db 
         fi
         if [ -f "./sqlite3/shopee/采集箱/粉丝/tw.db" ]; then
           cp ./sqlite3/shopee/采集箱/粉丝/tw.db ./releases/shopee_gather_fans_tw.db 
         fi
    - name: 自动发布固件到 Releases
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: sqlite3 文件发布
        tag_name: 1
        files: ./releases/* 
    # - name: 部署 sqlite3
    #   uses: JamesIves/github-pages-deploy-action@v4
    #   with: 
    #       branch: main
    #       folder: sqlite3/
    #       target-folder: sqlite3/
          
